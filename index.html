<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Imitation Player</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&family=Inter:wght@300;400;500;600&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #141720; --surface: #1e2333; --card: #2a3048;
    --accent: #4af0c8; --accent2: #6eb5ff;
    --text: #e8eaf0; --muted: #6b7280; --dim: #444c66;
    --border: rgba(255,255,255,0.07); --glow: rgba(74,240,200,0.15);
  }

  html, body {
    min-height: 100%; background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Inter', sans-serif;
  }

  /* ‚îÄ‚îÄ DEVICE (PC) ‚îÄ‚îÄ */
  .device {
    width: min(900px, 100vw);
    height: 520px;
    background: var(--surface);
    border-radius: 20px;
    border: 1px solid var(--border);
    box-shadow: 0 40px 120px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.06);
    display: flex; flex-direction: column;
    overflow: hidden;
  }

  /* Track tabs */
  .tracklist {
    display: flex; padding: 0 24px;
    background: rgba(0,0,0,0.25);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0; overflow-x: auto;
  }
  .tracklist::-webkit-scrollbar { display: none; }

  .track-tab {
    padding: 12px 16px; font-size: 12px; font-weight: 500;
    color: var(--muted); cursor: pointer;
    border-bottom: 2px solid transparent;
    border-left: none; border-right: none; border-top: none;
    background: none; transition: all 0.2s; white-space: nowrap;
  }
  .track-tab:hover { color: var(--text); }
  .track-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* Main layout */
  .main { flex: 1; display: flex; overflow: hidden; }

  /* LEFT */
  .left-panel {
    width: 280px; flex-shrink: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 16px 20px; gap: 14px;
    border-right: 1px solid var(--border);
  }

  .vinyl {
    width: 148px; height: 148px; border-radius: 50%;
    background: radial-gradient(circle at 50% 50%, #2a3048 0%, #0a0d14 60%, #1a1e2a 100%);
    box-shadow: 0 0 0 1px rgba(255,255,255,0.05), 0 8px 32px rgba(0,0,0,0.6), 0 0 60px var(--glow);
    position: relative; overflow: hidden; flex-shrink: 0;
  }
  .vinyl::before {
    content: ''; position: absolute; inset: 0; border-radius: 50%;
    background: repeating-radial-gradient(circle at 50% 50%, transparent 20px, rgba(255,255,255,0.015) 21px, transparent 22px);
  }
  .vinyl-inner {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
    width: 56px; height: 56px; border-radius: 50%;
    background: radial-gradient(circle at 40% 30%, rgba(74,240,200,0.3), #0a0d14);
    border: 2px solid rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center; font-size: 20px;
  }
  .vinyl-dot {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--accent); box-shadow: 0 0 8px var(--accent); z-index: 2;
  }
  .vinyl.spinning { animation: spin 4s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .wave-row { display: flex; align-items: center; gap: 2px; height: 22px; }
  .wbar { width: 3px; border-radius: 2px; background: var(--dim); transition: background 0.2s; }
  .wbar.active { background: var(--accent); animation: wv var(--s,0.5s) ease-in-out infinite alternate; }
  @keyframes wv { from { transform: scaleY(0.2); } to { transform: scaleY(1); } }

  .time-display {
    font-family: 'Orbitron', monospace; font-size: 12px; color: var(--muted);
    display: flex; align-items: center; gap: 6px;
  }
  .time-current { color: var(--text); }

  .controls { display: flex; align-items: center; gap: 14px; }
  .ctrl-btn {
    background: none; border: none; color: var(--muted); cursor: pointer;
    font-size: 18px; padding: 6px; border-radius: 50%; transition: all 0.15s;
    width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
  }
  .ctrl-btn:hover { color: var(--text); background: rgba(255,255,255,0.06); }

  .play-btn {
    width: 50px; height: 50px; border-radius: 50%;
    background: rgba(74,240,200,0.1); border: 1.5px solid var(--accent);
    color: var(--accent); font-size: 18px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; box-shadow: 0 0 20px var(--glow);
  }
  .play-btn:hover { background: rgba(74,240,200,0.2); }
  .play-btn.playing {
    background: rgba(110,181,255,0.1); border-color: var(--accent2); color: var(--accent2);
  }

  .options-row { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; justify-content: center; }
  .opt-label { font-size: 11px; color: var(--muted); }

  .spd-btn {
    background: var(--card); border: 1px solid var(--border); color: var(--muted);
    border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500;
    padding: 4px 7px; transition: all 0.15s;
  }
  .spd-btn.on { background: rgba(74,240,200,0.15); border-color: var(--accent); color: var(--accent); }

  .repeat-btn {
    background: var(--card); border: 1px solid var(--border); color: var(--muted);
    border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500;
    padding: 4px 10px; transition: all 0.15s;
  }
  .repeat-btn.on { background: rgba(74,240,200,0.15); border-color: var(--accent); color: var(--accent); }

  /* RIGHT */
  .right-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

  .right-header {
    padding: 14px 20px 12px; border-bottom: 1px solid var(--border);
    flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
  }
  .track-name { font-size: 15px; font-weight: 600; color: var(--text); }
  .meta-count { font-size: 11px; color: var(--muted); }

  .sentence-list { flex: 1; overflow-y: auto; padding: 6px 0; }
  .sentence-list::-webkit-scrollbar { width: 4px; }
  .sentence-list::-webkit-scrollbar-track { background: transparent; }
  .sentence-list::-webkit-scrollbar-thumb { background: var(--dim); border-radius: 2px; }

  .sentence-item {
    padding: 9px 16px 9px 20px;
    display: flex; align-items: center; gap: 12px;
    cursor: pointer; border-left: 2px solid transparent; transition: all 0.15s;
  }
  .sentence-item:hover { background: rgba(255,255,255,0.03); }
  .sentence-item.active { border-left-color: var(--accent); background: rgba(74,240,200,0.05); }

  .sent-num {
    font-family: 'Orbitron', monospace; font-size: 10px; color: var(--dim);
    width: 22px; flex-shrink: 0; text-align: right;
  }
  .sentence-item.active .sent-num { color: var(--accent); }

  .sent-text { flex: 1; font-size: 13px; line-height: 1.4; color: var(--muted); transition: color 0.15s; }
  .sentence-item.active .sent-text { color: var(--text); font-weight: 500; }
  .sent-text.hidden { color: var(--dim); letter-spacing: 0.15em; font-size: 12px; }

  .eye-btn {
    background: none; border: none; cursor: pointer; font-size: 14px;
    padding: 2px 4px; border-radius: 4px; transition: all 0.15s;
    flex-shrink: 0; opacity: 0; color: var(--dim);
  }
  .sentence-item:hover .eye-btn, .sentence-item.active .eye-btn { opacity: 1; }
  .eye-btn.on { color: var(--accent); opacity: 1; }

  /* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
  @media (max-width: 640px) {
    html, body { align-items: flex-start; }

    .device {
      width: 100vw; height: 100dvh;
      border-radius: 0; border: none;
      box-shadow: none;
    }

    .main { flex-direction: column; overflow: hidden; }

    /* Left panel ‚Üí compact horizontal strip */
    .left-panel {
      width: 100%; height: auto;
      flex-direction: column;
      border-right: none;
      border-bottom: 1px solid var(--border);
      padding: 12px 16px 14px;
      gap: 10px;
      justify-content: flex-start;
    }

    .vinyl-row {
      display: flex; align-items: center; gap: 16px; width: 100%;
    }

    .vinyl {
      width: 80px; height: 80px; flex-shrink: 0;
    }
    .vinyl-inner { width: 32px; height: 32px; font-size: 14px; }
    .vinyl-dot { width: 6px; height: 6px; }

    .vinyl-meta {
      flex: 1; display: flex; flex-direction: column; gap: 8px;
    }

    .time-display { font-size: 13px; }

    .controls { gap: 12px; }
    .play-btn { width: 46px; height: 46px; font-size: 16px; }
    .ctrl-btn { width: 34px; height: 34px; font-size: 16px; }

    .wave-row { display: none; }

    .options-row { justify-content: flex-start; }

    /* Right panel takes remaining space */
    .right-panel { flex: 1; min-height: 0; }

    .right-header { padding: 10px 16px; }
    .track-name { font-size: 14px; }

    .sentence-item { padding: 11px 14px 11px 16px; }
    .sent-text { font-size: 14px; }
    .eye-btn { opacity: 1; }
  }
</style>
</head>
<body>
<div class="device">
  <div class="tracklist" id="trackTabs"></div>

  <div class="main">
    <!-- LEFT -->
    <div class="left-panel">
      <!-- PC: normal flow / Mobile: vinyl-row wrapper -->
      <div class="vinyl-row" id="vinylRow">
        <div class="vinyl" id="vinyl">
          <div class="vinyl-inner">üé§</div>
          <div class="vinyl-dot"></div>
        </div>
        <div class="vinyl-meta" id="vinylMeta">
          <!-- filled by JS on mobile -->
        </div>
      </div>

      <div class="wave-row" id="waveRow"></div>

      <div class="time-display" id="timeDisplay">
        <span class="time-current" id="timeEl">01</span>
        <span>/</span>
        <span id="totalTime">--</span>
      </div>

      <div class="controls" id="controls">
        <button class="ctrl-btn" onclick="prev()">‚èÆ</button>
        <button class="play-btn" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
        <button class="ctrl-btn" onclick="next()">‚è≠</button>
        <button class="repeat-btn" id="repeatBtn" onclick="toggleRepeat()">‚Ü∫ OFF</button>
      </div>

      <div class="options-row">
        <span class="opt-label">ÈÄüÂ∫¶</span>
        <button class="spd-btn" onclick="setSpeed(0.75,this)">0.75x</button>
        <button class="spd-btn on" onclick="setSpeed(1.0,this)">1.0x</button>
        <button class="spd-btn" onclick="setSpeed(1.25,this)">1.25x</button>
        <button class="spd-btn" onclick="setSpeed(1.5,this)">1.5x</button>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right-panel">
      <div class="right-header">
        <div class="track-name" id="trackName">‚Äî</div>
        <div class="meta-count" id="metaCount">‚Äî</div>
      </div>
      <div class="sentence-list" id="sentenceList"></div>
    </div>
  </div>
</div>

<script>
let DATA = null;
let revealedState = {};
let trackIdx = 0, current = 0;
let audio = null, repeat = false, speed = 1.0, playing = false;

// Wave bars (PC only)
const waveRow = document.getElementById('waveRow');
for(let i=0;i<26;i++) {
  const b = document.createElement('div');
  b.className = 'wbar';
  b.style.height = (6+Math.random()*16)+'px';
  b.style.setProperty('--s',(0.35+Math.random()*0.45).toFixed(2)+'s');
  b.style.animationDelay = (Math.random()*0.3).toFixed(2)+'s';
  waveRow.appendChild(b);
}

// On mobile: move time + controls into vinyl-meta
function applyMobileLayout() {
  if(window.innerWidth > 640) return;
  const meta = document.getElementById('vinylMeta');
  if(meta.children.length > 0) return;
  meta.appendChild(document.getElementById('timeDisplay'));
  meta.appendChild(document.getElementById('controls'));
}
applyMobileLayout();
window.addEventListener('resize', applyMobileLayout);

function buildSentenceList() {
  const list = document.getElementById('sentenceList');
  list.innerHTML = '';
  DATA[trackIdx].segments.forEach((seg, i) => {
    const revealed = revealedState[trackIdx][i];
    const div = document.createElement('div');
    div.className = 'sentence-item' + (i===current?' active':'');
    div.id = 'sent-' + i;
    div.onclick = (e) => { if(!e.target.closest('.eye-btn')) loadAndPlay(i); };

    const numEl = document.createElement('span');
    numEl.className = 'sent-num';
    numEl.textContent = String(i+1).padStart(2,'0');

    const textEl = document.createElement('span');
    textEl.className = 'sent-text' + (revealed?'':' hidden');
    textEl.id = 'text-' + i;
    textEl.textContent = revealed ? seg.transcript : '‚Ä¢  ‚Ä¢  ‚Ä¢  ‚Ä¢  ‚Ä¢  ‚Ä¢  ‚Ä¢  ‚Ä¢';

    const eyeBtn = document.createElement('button');
    eyeBtn.className = 'eye-btn' + (revealed?' on':'');
    eyeBtn.textContent = 'üëÅ';
    eyeBtn.onclick = (e) => { e.stopPropagation(); toggleReveal(i); };

    div.appendChild(numEl);
    div.appendChild(textEl);
    div.appendChild(eyeBtn);
    list.appendChild(div);
  });
}

function toggleReveal(i) {
  revealedState[trackIdx][i] = !revealedState[trackIdx][i];
  const revealed = revealedState[trackIdx][i];
  const seg = DATA[trackIdx].segments[i];
  const textEl = document.getElementById('text-' + i);
  textEl.className = 'sent-text' + (revealed?'':' hidden');
  textEl.textContent = revealed ? seg.transcript : '‚Ä¢  ‚Ä¢  ‚Ä¢  ‚Ä¢  ‚Ä¢  ‚Ä¢  ‚Ä¢  ‚Ä¢';
  textEl.nextElementSibling.classList.toggle('on', revealed);
}

function updateUI() {
  const segs = DATA[trackIdx].segments;
  document.getElementById('trackName').textContent = DATA[trackIdx].label;
  document.getElementById('metaCount').textContent = segs.length + ' sentences';
  document.getElementById('timeEl').textContent = String(current+1).padStart(2,'0');
  document.getElementById('totalTime').textContent = String(segs.length).padStart(2,'0');
  document.querySelectorAll('.sentence-item').forEach((el,i) => el.classList.toggle('active', i===current));
  const activeEl = document.getElementById('sent-'+current);
  if(activeEl) activeEl.scrollIntoView({block:'nearest', behavior:'smooth'});
}

function setWave(on) {
  document.querySelectorAll('.wbar').forEach(b => b.classList.toggle('active', on));
  document.getElementById('vinyl').classList.toggle('spinning', on);
}

function selectTrack(i) {
  if(audio) { audio.pause(); audio = null; }
  playing = false; setWave(false);
  trackIdx = i; current = 0;
  document.querySelectorAll('.track-tab').forEach((t,j) => t.classList.toggle('active', j===i));
  document.getElementById('playBtn').textContent = '‚ñ∂';
  document.getElementById('playBtn').classList.remove('playing');
  buildSentenceList(); updateUI();
}

function loadAndPlay(idx) {
  if(audio) { audio.pause(); audio = null; }
  current = idx; updateUI();
  const key = DATA[trackIdx].key;
  const src = 'audio/segments/' + key + '/' + String(current).padStart(2,'0') + '.mp3';
  audio = new Audio(src);
  audio.playbackRate = speed;
  audio.onended = () => {
    setWave(false); playing = false;
    document.getElementById('playBtn').textContent = '‚ñ∂';
    document.getElementById('playBtn').classList.remove('playing');
    const n = DATA[trackIdx].segments.length;
    if(repeat) setTimeout(() => loadAndPlay(current), 0);
    else if(current < n-1) setTimeout(() => loadAndPlay(current+1), 0);
  };
  audio.play().catch(e => console.log(e));
  playing = true; setWave(true);
  document.getElementById('playBtn').textContent = '‚è∏';
  document.getElementById('playBtn').classList.add('playing');
}

function togglePlay() {
  if(playing) {
    audio.pause(); playing = false; setWave(false);
    document.getElementById('playBtn').textContent = '‚ñ∂';
    document.getElementById('playBtn').classList.remove('playing');
  } else {
    if(audio && audio.paused) {
      audio.play(); playing = true; setWave(true);
      document.getElementById('playBtn').textContent = '‚è∏';
      document.getElementById('playBtn').classList.add('playing');
    } else loadAndPlay(current);
  }
}

function prev() { if(current > 0) loadAndPlay(current-1); }
function next() { const n = DATA[trackIdx].segments.length; if(current < n-1) loadAndPlay(current+1); }

function toggleRepeat() {
  repeat = !repeat;
  document.getElementById('repeatBtn').textContent = repeat ? '‚Ü∫ ON' : '‚Ü∫ OFF';
  document.getElementById('repeatBtn').classList.toggle('on', repeat);
}

function setSpeed(s, el) {
  speed = s;
  if(audio) audio.playbackRate = s;
  document.querySelectorAll('.spd-btn').forEach(b => b.classList.remove('on'));
  el.classList.add('on');
}

document.addEventListener('keydown', e => {
  if(e.code==='Space') { e.preventDefault(); togglePlay(); }
  if(e.code==='ArrowRight') next();
  if(e.code==='ArrowLeft') prev();
});

fetch('data.json')
  .then(r => r.json())
  .then(d => {
    DATA = d;
    const tabsEl = document.getElementById('trackTabs');
    DATA.forEach((t,i) => {
      const btn = document.createElement('button');
      btn.className = 'track-tab' + (i===0?' active':'');
      btn.textContent = t.label;
      btn.onclick = () => selectTrack(i);
      tabsEl.appendChild(btn);
      revealedState[i] = new Array(t.segments.length).fill(false);
    });
    selectTrack(0);
  });
</script>
</body>
</html>
